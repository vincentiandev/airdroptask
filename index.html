<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HolderW8r ‚Äî Rebuilt + Dark Mode & Animations</title>

  <style>
    /* =======================
       Theme variables (light & dark)
       ======================= */
    :root{
      --bg: #f6f8fa;
      --card: #ffffff;
      --text: #0b1220;
      --muted: #556;
      --accent: #0066ff;
      --accent-2:#00ffd1;
      --surface-shadow: 0 6px 18px rgba(10,20,40,0.06);
      --glass: rgba(255,255,255,0.6);
      --toast-bg: rgba(0,0,0,0.85);
      --duration-fast: 180ms;
      --duration-med: 350ms;
      --duration-slow: 500ms;
      --ease: cubic-bezier(.2,.9,.3,1);
    }

    [data-theme="dark"]{
      --bg: linear-gradient(180deg,#000 0%,#031014 100%);
      --card: #071014;
      --text: #e6fff7;
      --muted: #9ee;
      --accent: #00ffd1;
      --accent-2:#00ccff;
      --surface-shadow: 0 10px 30px rgba(0,0,0,0.6);
      --glass: rgba(3,16,20,0.6);
      --toast-bg: rgba(0,0,0,0.85);
    }

    /* Respect system preference on first load */
    @media (prefers-color-scheme: dark){
      :root:not([data-theme]){ --auto-dark: 1; }
    }

    /* =======================
       Base layout
       ======================= */
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    body{
      background: var(--bg);
      color: var(--text);
      transition: background var(--duration-med) var(--ease), color var(--duration-med) var(--ease);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:84px; /* nav area */
    }

    .wrap{ max-width:1100px; margin:18px auto; padding:14px; box-sizing:border-box; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    h1{ margin:0; font-size:20px; color:var(--accent); letter-spacing:0.2px; }

    /* =======================
       Cards + components
       ======================= */
    .card{
      background: var(--card);
      border-radius:12px;
      padding:12px;
      box-shadow: var(--surface-shadow);
      border: 1px solid rgba(0,0,0,0.03);
      transition: transform var(--duration-med) var(--ease), box-shadow var(--duration-med) var(--ease), background var(--duration-med) var(--ease);
      will-change: transform;
      opacity:0;
      transform: translateY(8px);
      animation: cardIn var(--duration-slow) var(--ease) both;
    }

    @keyframes cardIn{
      to { opacity:1; transform:none; }
    }

    .small{ font-size:0.92rem; color:var(--muted); }
    .muted{ color:var(--muted); font-size:0.95rem; }
    .thumb{ max-width:200px; border-radius:8px; margin-top:8px; display:block; }

    /* Buttons */
    .btn{
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      color: #001;
      padding:10px 12px;
      border-radius:10px;
      border:0;
      font-weight:700;
      cursor:pointer;
      transition: transform var(--duration-fast) var(--ease), box-shadow var(--duration-fast) var(--ease);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    .btn:active{ transform: translateY(1px) scale(0.997); }
    .btn:focus{ outline:3px solid rgba(0,255,209,0.12); outline-offset:4px; }
    .navbtn{ background:transparent; border:0; color:var(--accent); font-weight:700; cursor:pointer; }

    /* Form fields */
    input[type="text"], input[type="number"], input[type="password"], textarea, select{
      width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.55));
      transition: background var(--duration-med) var(--ease), border-color var(--duration-med) var(--ease);
    }
    [data-theme="dark"] input[type="text"], [data-theme="dark"] textarea{
      background: linear-gradient(180deg, rgba(10,20,28,0.6), rgba(6,16,22,0.6));
      border:1px solid rgba(255,255,255,0.04);
      color:var(--text);
    }

    /* =======================
       Bottom nav
       ======================= */
    nav.bottom{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:14px; background: rgba(0,0,0,0.6); padding:10px; border-radius:999px; display:flex; gap:8px;
      z-index:9999; backdrop-filter: blur(6px);
    }
    nav.bottom .navbtn{ color: var(--accent); background: transparent; padding:8px 12px; border-radius:10px; border:0; }

    /* FAB */
    #fabAdmin{ position:fixed; right:20px; bottom:90px; width:60px; height:60px; border-radius:50%; font-size:22px; cursor:pointer; z-index:9999; border:0; box-shadow:0 8px 28px rgba(0,0,0,0.35); transition: transform var(--duration-fast) var(--ease); }
    #fabAdmin:active{ transform: translateY(2px); }

    /* Toasts */
    .toast-wrap{ position:fixed; top:18px; left:50%; transform:translateX(-50%); z-index:10000; pointer-events:none; }
    .toast{
      display:inline-block; min-width:260px; padding:12px 14px; border-radius:10px; margin-top:8px;
      background:var(--toast-bg); color:#fff; box-shadow:0 8px 30px rgba(0,0,0,0.6);
      border-left:6px solid var(--accent);
      transform: translateY(-10px) scale(.995); opacity:0;
      animation: toastIn var(--duration-fast) var(--ease) forwards;
      pointer-events:auto;
    }
    @keyframes toastIn{ to{ transform:none; opacity:1; } }
    @keyframes toastOut{ to{ transform: translateY(-10px); opacity:0; } }

    /* Modal (backup preview) */
    #backupPreviewModal{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:20000;
      background: rgba(3,6,10,0.5); animation: modalFade var(--duration-med) var(--ease) both;
    }
    @keyframes modalFade{ from{ opacity:0; transform:scale(.98);} to{ opacity:1; transform:none; } }
    #backupPreviewModal .box{ background:var(--card); color:var(--text); padding:18px; border-radius:12px; width:90%; max-width:900px; max-height:80%; overflow:auto; box-shadow:var(--surface-shadow); }

    /* subtle hover glow for interactive cards */
    .card:hover{ transform: translateY(-6px); box-shadow: 0 18px 60px rgba(0,0,0,0.12); }

    /* small utilities */
    .muted-block{ color:var(--muted); font-size:0.95rem; }

    /* animations for admin content reveal */
    .adm-enter{ animation: slideLeftIn var(--duration-med) var(--ease) both; }
    @keyframes slideLeftIn{ from{ transform: translateX(40px); opacity:0 } to{ transform:none; opacity:1 } }

    /* task popup */
    #taskPopup{ position:fixed; right:20px; bottom:160px; background:var(--card); color:var(--text); padding:14px; border-radius:12px; box-shadow:var(--surface-shadow); border-left:6px solid var(--accent); min-width:260px; display:none; z-index:9998; transform-origin: right bottom; animation: popupScale 450ms var(--ease) both; }
    @keyframes popupScale{ from{ transform: scale(.98) translateY(8px); opacity:0 } to{ transform:none; opacity:1 } }

    /* responsiveness */
    @media (max-width:700px){
      .wrap{ padding:10px; }
      .thumb{ max-width: 100%; }
    }
  </style>
</head>
<body>

  <div class="wrap" id="appWrap">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <h1>HolderW8r</h1>
        <div class="small muted-block" id="uidTopWrap">User: <strong id="uidTop">-</strong></div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <div class="small muted-block">Balance: $<span id="topBal">0.00</span></div>

        <!-- Theme toggle -->
        <button class="btn" id="themeToggle" title="Toggle dark / light">Toggle Theme</button>

        <!-- Admin FAB -->
        <button id="fabAdmin" class="btn" title="Open admin login">‚öôÔ∏è</button>
      </div>
    </header>

    <!-- User app -->
    <div id="userApp" class="content">
      <div id="screen-tasks" class="card adm-enter">
        <h2>‚úÖ Tasks</h2>
        <div class="muted-block">Complete tasks one-by-one. Upload proof for approval. While waiting you can proceed to the next task. Tasks expire after 5 minutes if not approved.</div>
        <div id="taskList" style="margin-top:12px"></div>
      </div>

      <div id="screen-flow" class="card" style="display:none">
        <h2 id="taskTitle">Task</h2>
        <div id="taskFlow"></div>
        <div style="margin-top:12px"><button class="btn" id="backUserFlow">Back to Tasks</button></div>
      </div>

      <div id="screen-home" class="card" style="display:none">
        <h2>üí∞ Wallet</h2>
        <div>User: <strong id="uidUser">-</strong></div>
        <div>Balance: $<span id="balance">0.00</span></div>
        <div>Referral Balance: $<span id="refBalance">0.00</span></div>
      </div>

      <div id="screen-referral" class="card" style="display:none">
        <h2>üì§ Invite</h2>
        <div>Your join link:</div>
        <div id="refLink" style="word-break:break-all;margin-top:8px"></div>
        <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="copyRefBtn">Copy Join Link</button><button class="btn" id="openRefBtn">Open Join Link</button></div>
      </div>

      <div id="screen-notifs" class="card" style="display:none">
        <h2>üîî Notifications</h2>
        <div id="notifList"></div>
      </div>
    </div>

    <!-- Admin login & app -->
    <div id="adminLogin" class="card" style="display:none; margin-top:12px">
      <h2>Admin Login</h2>
      <input id="adminPass" placeholder="Password or code" type="password"/>
      <div style="margin-top:8px"><button class="btn" id="adminLoginBtn">Login</button></div>
    </div>

    <div id="adminApp" style="display:none; margin-top:12px">
      <div class="card">
        <h2>Admin Panel</h2>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn" id="openAdminBtn">Open Admin Dashboard</button>
          <button class="btn" id="logoutAdminBtn">Logout Admin View</button>
        </div>
      </div>
    </div>

    <div id="fullAdminPanel" style="display:none;margin-top:12px"></div>
  </div>

  <nav class="bottom">
    <button class="navbtn" id="navTasks">‚úÖ Tasks</button>
    <button class="navbtn" id="navWallet">üí∞ Wallet</button>
    <button class="navbtn" id="navReferralBtn">üì§ Invite</button>
    <button class="navbtn" id="navNotifs">üîî Notifications</button>
    <button class="navbtn" id="navAdminBtn">üõ†Ô∏è Admin</button>
  </nav>

  <div class="toast-wrap" id="toasts"></div>
  <div id="taskPopup" style="display:none;"></div>
  <div id="backupModalPlaceholder"></div>

<script>
/* ======================================================
   DATA KEYS & BOOTSTRAP
   ====================================================== */
const STORAGE_USERS = 'HW_USERS_V5';
const STORAGE_CURRENT = 'HW_CURRENT_ID_V5';
const STORAGE_SUBS = 'HW_SUBMISSIONS_V5';
const STORAGE_TASKS = 'HW_TASKS_V5';
const STORAGE_TELEWEB = 'HW_TELEGRAM_WEBHOOK_V5';
const STORAGE_THEME = 'HW_THEME_V5';

function loadJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; } }
function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

let USERS = loadJSON(STORAGE_USERS, {});
let TASKS = loadJSON(STORAGE_TASKS, null);
if(!Array.isArray(TASKS) || TASKS.length===0){
  TASKS = [
    {title:'Register on Spurbets', reward:5, link:'https://spurbets.com?ref=1099110'},
    {title:'Register on Safibets', reward:5, link:'https://www.safibets.com/?ref=1131694'},
    {title:'Register on OlympTrade', reward:8, link:'https://static.olymptrade.com/lands/LPL92-01-02en/index.html'},
    {title:'Register on Pocket Option', reward:7, link:'https://u3.shortink.io/register?utm_campaign=833050&utm_source=affiliate&utm_medium=sr&a=KlA04cjbIzPPbs&ac=milliondollar&code=WELCOME50'},
    {title:'Register on Binance', reward:12, link:'https://www.binance.com/activity/referral-entry/CPA?ref=CPA_00ZV7WCRL8'},
    {title:'Register on OKX', reward:10, link:'https://okx.com/join/97395294'},
    {title:'Join @taskernbot', reward:6, link:'https://t.me/taskernbot'},
    {title:'Open GOLD WebApp', reward:9, link:'https://t.me/taskernbot/GOLDwebapp'}
  ];
  saveJSON(STORAGE_TASKS, TASKS);
}

let CURRENT_ID = localStorage.getItem(STORAGE_CURRENT) || (function(){ const id = 'user_' + Math.random().toString(36).slice(2,9); localStorage.setItem(STORAGE_CURRENT, id); return id; })();
if(!USERS[CURRENT_ID]) USERS[CURRENT_ID] = { id:CURRENT_ID, role:'user', balance:0, refBalance:0, completedTasks:[], referrals:[], referrer:null, notifications:[] };
saveJSON(STORAGE_USERS, USERS);

function loadSubs(){ return loadJSON(STORAGE_SUBS, []); }
function saveSubs(a){ saveJSON(STORAGE_SUBS, a); }
function saveUsers(){ saveJSON(STORAGE_USERS, USERS); }

/* =========================
   THEME (dark / light)
   ========================= */
function applyTheme(theme){
  if(theme === 'dark') document.documentElement.setAttribute('data-theme','dark');
  else if(theme === 'light') document.documentElement.removeAttribute('data-theme');
  localStorage.setItem(STORAGE_THEME, theme);
  // announce small ripple
  document.getElementById('themeToggle').textContent = (theme==='dark') ? 'Light' : 'Dark';
}

(function initTheme(){
  const saved = localStorage.getItem(STORAGE_THEME);
  if(saved){ applyTheme(saved); return; }
  // fallback to system preference
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyTheme(prefersDark ? 'dark' : 'light');
})();

document.getElementById('themeToggle').addEventListener('click', ()=>{
  const current = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
  applyTheme(current === 'dark' ? 'light' : 'dark');
});

/* =========================
   TOASTS (animated)
   ========================= */
function showToast(txt){
  const wrap = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = txt;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.animation = 'toastOut 300ms ease forwards'; setTimeout(()=>el.remove(), 320); }, 4200);
}

/* =========================
   TELEGRAM STUB
   ========================= */
async function sendTelegramNotification(sub){ const webhook = localStorage.getItem(STORAGE_TELEWEB); if(!webhook) return; try{ await fetch(webhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: `New submission: ${sub.userId} task:${sub.taskIndex+1}` }) }); }catch(e){ console.warn('Telegram notify failed', e); } }

/* =========================
   DUPLICATE CHECK
   ========================= */
function isDuplicateAccount(taskIndex, accountId){
  if(!accountId) return false;
  const subs = loadSubs();
  return subs.some(s => s.taskIndex === taskIndex && s.accountId && s.accountId.toLowerCase() === accountId.toLowerCase() && (s.status === 'pending' || s.status === 'approved'));
}

/* =========================
   USER TASKS RENDER
   ========================= */
function renderTaskList(){
  const container = document.getElementById('taskList');
  if(!container) return;
  container.innerHTML = '';
  const subs = loadSubs();
  for(let i=0;i<TASKS.length;i++){
    const t = TASKS[i];
    const latest = subs.filter(s=>s.userId===CURRENT_ID && s.taskIndex===i).sort((a,b)=>b.createdAt-a.createdAt)[0];
    const prev = subs.filter(s=>s.userId===CURRENT_ID && s.taskIndex===i-1).sort((a,b)=>b.createdAt-a.createdAt)[0];
    const unlocked = i===0 || (USERS[CURRENT_ID].completedTasks.includes(i-1)) || (prev && (prev.status==='pending' || prev.status==='approved'));
    const visible = !(latest && latest.status==='approved');
    if(!visible) continue;
    const statusLabel = latest ? latest.status : '';
    const minPay = Math.max(2, Math.floor(TASKS[i].reward * 0.5));
    const maxPay = Math.min(5, Math.ceil(TASKS[i].reward));
    const payRange = `$${minPay}-${maxPay}`;

    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
      <div><strong>Task ${i+1}</strong><div class='small muted-block'>${t.title}</div><div class='small muted-block'>Pay: ${payRange}</div><div class='small muted-block'>${statusLabel?('Status: '+statusLabel):''}</div></div>
      <div>${unlocked?'<button class="btn" data-open="'+i+'">Open</button>':'Locked'}</div>
    </div>`;
    container.appendChild(card);
  }
  document.querySelectorAll('button[data-open]').forEach(b=>b.addEventListener('click', ()=>{ openUserTask(parseInt(b.getAttribute('data-open'))); }));
}

/* Flow to open specific task */
let currentTaskIndex = null;
function openUserTask(i){
  currentTaskIndex = i;
  const t = TASKS[i];
  showUserScreen('flow');
  document.getElementById('taskTitle').textContent = 'Task '+(i+1)+' ‚Äî '+t.title;
  const flow = document.getElementById('taskFlow');
  const latest = loadSubs().filter(s=>s.userId===CURRENT_ID && s.taskIndex===i).sort((a,b)=>b.createdAt-a.createdAt)[0];
  const prefill = latest? latest.accountId||'':'';
  const proofPreview = latest && latest.proof ? `<div class='muted-block'>Previous proof:</div><img src='${latest.proof}' class='thumb'/>` : '';
  flow.innerHTML = `
    <div class='muted-block' style='margin-top:8px'>Follow instructions carefully. Create a NEW account for this task to be approved. Each account must be unique.</div>
    <div class='muted-block' style='margin-top:8px'>Open this link:</div>
    <button class='btn' id='openTaskLink'>Open Task</button>
    <div class='muted-block' style='margin-top:8px'>Account ID</div>
    <input id='accInput' placeholder='Account ID' value='${prefill}' />
    <div class='muted-block' style='margin-top:8px'>Upload screenshot / proof (image)</div>
    <input type='file' id='proofFile' accept='image/*' />
    ${proofPreview}
    <div style='margin-top:8px'><button class='btn' id='submitUserTask'>Submit</button></div>
  `;
  document.getElementById('openTaskLink').addEventListener('click', ()=>{ window.open(t.link, '_blank'); });
  document.getElementById('submitUserTask').addEventListener('click', submitUserTask);
}

/* Submit handler */
function submitUserTask(){
  const acc = (document.getElementById('accInput')||{}).value.trim();
  if(!acc){ alert('Enter account ID'); return; }
  if(isDuplicateAccount(currentTaskIndex, acc)){ alert('Duplicate account detected for this task. Please create a unique account.'); return; }
  const fileEl = document.getElementById('proofFile');
  const subs = loadSubs();
  const push = (dataUrl)=>{
    const sub = { id:'sub_'+Math.random().toString(36).slice(2,9), userId:CURRENT_ID, taskIndex:currentTaskIndex, accountId:acc, proof:dataUrl||null, status:'pending', createdAt:Date.now(), assignedTo:null };
    subs.push(sub);
    saveSubs(subs);
    sendTelegramNotification(sub);
    showToast('Submitted for review');
    renderTaskList();
    renderTasksForUser();
    try{ refreshAdminPanels(); }catch(e){}
    setTimeout(()=>{ showUserScreen('tasks'); },600);
  };
  if(fileEl && fileEl.files && fileEl.files[0]){ const fr = new FileReader(); fr.onload = function(e){ push(e.target.result); }; fr.readAsDataURL(fileEl.files[0]); } else { push(null); }
}

/* =========================
   UI helpers
   ========================= */
function showUserScreen(id){
  document.getElementById('screen-tasks').style.display = id==='tasks' ? 'block' : 'none';
  document.getElementById('screen-home').style.display = id==='home' ? 'block' : 'none';
  document.getElementById('screen-referral').style.display = id==='referral' ? 'block' : 'none';
  document.getElementById('screen-notifs').style.display = id==='notifs' ? 'block' : 'none';
  document.getElementById('screen-flow').style.display = id==='flow' ? 'block' : 'none';
  if(id==='tasks') renderTaskList();
  if(id==='home') renderWallet();
  if(id==='referral') renderReferral();
  if(id==='notifs') renderNotifications();
}

function renderWallet(){ document.getElementById('uidUser').textContent = CURRENT_ID; document.getElementById('balance').textContent = (USERS[CURRENT_ID].balance||0).toFixed(2); document.getElementById('refBalance').textContent = (USERS[CURRENT_ID].refBalance||0).toFixed(2); document.getElementById('topBal').textContent = (USERS[CURRENT_ID].balance||0).toFixed(2); }
function renderReferral(){ const link = location.origin + location.pathname + '?join=' + CURRENT_ID; document.getElementById('refLink').innerHTML = `<a href='${link}' target='_blank'>${link}</a>`; }
function copyRef(){ navigator.clipboard.writeText(location.origin + location.pathname + '?join=' + CURRENT_ID).then(()=>showToast('Join link copied')); }
function openJoin(){ window.open(location.origin + location.pathname + '?join=' + CURRENT_ID, '_blank'); }
function renderNotifications(){ const list = document.getElementById('notifList'); if(!list) return; const nots = (USERS[CURRENT_ID].notifications||[]).slice().reverse(); if(!nots.length){ list.innerHTML = '<div class="muted-block">No notifications</div>'; return; } list.innerHTML=''; nots.forEach(n=>{ const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div><strong>${n.title}</strong><div class='small'>${new Date(n.createdAt).toLocaleString()}</div><div style='margin-top:8px'>${n.message}</div></div>`; list.appendChild(d); }); }

/* =========================
   ADMIN: renderers & actions
   ========================= */
function openFullAdminPanel(){ const allowed = (USERS[CURRENT_ID] && (USERS[CURRENT_ID].role==='admin' || USERS[CURRENT_ID].role==='moderator' || USERS[CURRENT_ID].role==='superadmin')) || false; if(!allowed){ showToast('No admin permission ‚Äî please login'); return; } const panel = document.getElementById('fullAdminPanel'); panel.style.display='block'; panel.classList.add('adm-enter'); panel.innerHTML = `
    <div class='card'>
      <h3>Admin Dashboard</h3>
      <div style='display:flex;gap:8px;flex-wrap:wrap'>
        <button class='btn' id='admOverviewBtn'>Overview</button>
        <button class='btn' id='admSubsBtn'>Submissions</button>
        <button class='btn' id='admModerBtn'>Moderator Review</button>
        <button class='btn' id='admTasksBtn'>Tasks</button>
        <button class='btn' id='admRolesBtn'>Roles</button>
        <button class='btn' id='admAnalyticsBtn'>Analytics</button>
        <button class='btn' id='admSettingsBtn'>Settings</button>
      </div>
    </div>
    <div id='admContent'></div>
  `; // attach listeners
  document.getElementById('admOverviewBtn').addEventListener('click', renderAdminOverview);
  document.getElementById('admSubsBtn').addEventListener('click', ()=>renderAdminSubmissions(true));
  document.getElementById('admModerBtn').addEventListener('click', renderModeratorPanel);
  document.getElementById('admTasksBtn').addEventListener('click', renderAdminTasks);
  document.getElementById('admRolesBtn').addEventListener('click', renderAdminUsers);
  document.getElementById('admAnalyticsBtn').addEventListener('click', renderAdminAnalytics);
  document.getElementById('admSettingsBtn').addEventListener('click', renderAdminSettings);
  // auto-open submissions (Option A)
  setTimeout(()=>{ document.getElementById('admSubsBtn').click(); }, 80);
}

function renderAdminOverview(){ const el=document.getElementById('admContent'); el.innerHTML = `<div class='card'><h4>Overview</h4><div>Users: ${Object.keys(USERS).length}</div><div>Submissions: ${loadSubs().length}</div></div>`; }
function renderAdminSubmissions(drawNow=false){
  const el=document.getElementById('admContent');
  function draw(){
    const subs = loadSubs().slice().reverse();
    let html = `<div class='card'><h4>Submissions</h4>` + (subs.length? '':'<div class="muted-block">No submissions</div>');
    subs.forEach(s=>{
      html += `<div class='card'><strong>${s.userId}</strong> - Task ${s.taskIndex+1}<div class='small'>${s.accountId||'-'}</div>${s.proof?`<img src='${s.proof}' class='thumb'/>`:''}<div class='small'>Status: ${s.status} ${s.assignedTo?(' | assigned: '+s.assignedTo):''}</div><div style='margin-top:8px'>${s.status!=='approved'?`<button class='btn' data-a='${s.id}'>Approve</button> <button class='btn' data-r='${s.id}'>Reject</button> <button class='btn' data-assign='${s.id}'>Assign</button>`:''}</div></div>`;
    });
    html += '</div>';
    el.innerHTML = html;
    el.querySelectorAll('button[data-a]').forEach(b=>b.addEventListener('click', ()=>{ adminApprove(b.getAttribute('data-a')); draw(); }));
    el.querySelectorAll('button[data-r]').forEach(b=>b.addEventListener('click', ()=>{ adminReject(b.getAttribute('data-r')); draw(); }));
    el.querySelectorAll('button[data-assign]').forEach(b=>b.addEventListener('click', ()=>{ const id=b.getAttribute('data-assign'); const mod = prompt('Assign to moderator (user id)'); if(mod){ assignSubmissionTo(id, mod); draw(); } }));
  }
  if(drawNow) draw();
}

function renderModeratorPanel(){
  const el=document.getElementById('admContent');
  const subs = loadSubs().filter(s=> s.status==='pending' && (!s.assignedTo || s.assignedTo===CURRENT_ID)).slice().reverse();
  let html = `<div class='card'><h4>Moderator Review</h4>` + (subs.length? '':'<div class="muted-block">No submissions to review (for you)</div>');
  subs.forEach(s=>{
    html += `<div class='card'><strong>${s.userId}</strong> - Task ${s.taskIndex+1}<div class='small'>${s.accountId||'-'}</div>${s.proof?`<img src='${s.proof}' class='thumb'/>`:''}<div class='small'>Status: ${s.status}</div><div style='margin-top:8px'><button class='btn' data-ma='${s.id}'>Approve</button> <button class='btn' data-mr='${s.id}'>Reject</button></div></div>`;
  });
  html += '</div>';
  el.innerHTML = html;
  el.querySelectorAll('button[data-ma]').forEach(b=>b.addEventListener('click', ()=>{ adminApprove(b.getAttribute('data-ma')); renderModeratorPanel(); renderAdminSubmissions(); }));
  el.querySelectorAll('button[data-mr]').forEach(b=>b.addEventListener('click', ()=>{ adminReject(b.getAttribute('data-mr')); renderModeratorPanel(); renderAdminSubmissions(); }));
}

function renderAdminTasks(){
  const el=document.getElementById('admContent');
  let html = `<div class='card'><h4>Tasks</h4></div>`;
  TASKS.forEach((t,i)=>{ html += `<div class='card'><strong>${t.title}</strong> <div class='small'>$${t.reward} ‚Äî ${t.link}</div><div style='margin-top:8px'><button class='btn' data-del='${i}'>Delete</button></div></div>`; });
  html += `<div class='card'><h4>Add Task</h4><input id='newTaskTitle' placeholder='Title'/><input id='newTaskReward' type='number' placeholder='Reward'/><input id='newTaskLink' placeholder='Link'/><div style='margin-top:8px'><button class='btn' id='addTaskBtn'>Add Task</button></div></div>`;
  el.innerHTML = html;
  el.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click', ()=>{ TASKS.splice(parseInt(b.getAttribute('data-del')),1); saveJSON(STORAGE_TASKS, TASKS); showToast('Task removed'); renderAdminTasks(); }));
  const addBtn = document.getElementById('addTaskBtn'); if(addBtn) addBtn.addEventListener('click', ()=>{ const title = document.getElementById('newTaskTitle').value.trim(); const reward = parseFloat(document.getElementById('newTaskReward').value) || 0; const link = document.getElementById('newTaskLink').value.trim(); if(!title || !link || !reward){ showToast('Fill all fields'); return; } TASKS.push({ title, reward, link }); saveJSON(STORAGE_TASKS, TASKS); showToast('Task added'); renderAdminTasks(); });
}

function renderAdminUsers(){
  const el=document.getElementById('admContent');
  let html = `<div class='card'><h4>Users & Roles</h4></div>`;
  Object.keys(USERS).forEach(uid=>{ const u = USERS[uid]; html += `<div class='card'><strong>${uid}</strong><div class='small'>role: ${u.role||'user'}</div><div style='margin-top:8px'><select data-role='${uid}'><option value='user' ${u.role==='user'?'selected':''}>User</option><option value='moderator' ${u.role==='moderator'?'selected':''}>Moderator</option><option value='admin' ${u.role==='admin'?'selected':''}>Admin</option><option value='superadmin' ${u.role==='superadmin'?'selected':''}>SuperAdmin</option></select></div></div>`; });
  el.innerHTML = html;
  el.querySelectorAll('select[data-role]').forEach(s=>s.addEventListener('change', ()=>{ const uid = s.getAttribute('data-role'); USERS[uid].role = s.value; saveUsers(); showToast('Role updated'); renderAdminUsers(); }));
}

function renderAdminAnalytics(){
  const el=document.getElementById('admContent');
  const subs = loadSubs();
  const total = subs.length;
  const pending = subs.filter(s=>s.status==='pending').length;
  const approved = subs.filter(s=>s.status==='approved').length;
  const rejected = subs.filter(s=>s.status==='rejected').length;
  const totalReferrals = Object.values(USERS).reduce((acc,u)=>acc + (u.referrals?u.referrals.length:0),0);
  const totalRefEarnings = Object.values(USERS).reduce((acc,u)=>acc + (u.refBalance||0),0);
  let html = `<div class='card'><h4>Analytics</h4><div>Total submissions: ${total}</div><div>Pending: ${pending}</div><div>Approved: ${approved}</div><div>Rejected: ${rejected}</div><div style='margin-top:8px'>Total referrals: ${totalReferrals}</div><div>Referral payouts (total): $${totalRefEarnings.toFixed(2)}</div><div style='margin-top:12px'><button class='btn' id='exportCsv'>Export submissions CSV</button></div></div>`;
  el.innerHTML = html;
  document.getElementById('exportCsv').addEventListener('click', ()=>{ const rows = [['id','userId','taskIndex','accountId','status','createdAt']]; loadSubs().forEach(s=> rows.push([s.id, s.userId, s.taskIndex, s.accountId||'', s.status, new Date(s.createdAt).toISOString()])); const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'submissions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });
}

function renderAdminSettings(){
  const el=document.getElementById('admContent');
  const saved = localStorage.getItem(STORAGE_TELEWEB)||'';
  el.innerHTML = `<div class='card'><h4>Settings</h4><div class='small muted-block'>Telegram webhook (POST JSON):</div><input id='teleWebhook' placeholder='https://...' value='${saved}'/><div style='margin-top:8px'><button class='btn' id='saveWeb'>Save</button> <button class='btn' id='clearWeb'>Clear</button></div></div>
  <div class='card'>
    <h4>Backup & Restore</h4>
    <button class='btn' id='exportBackupBtn'>Export Backup</button>
    <div style='margin-top:8px;display:flex;gap:8px;align-items:center'>
      <input type='file' id='importBackupInput' style='flex:1'/>
      <button class='btn' id='importBackupBtn'>Import</button>
    </div>
  </div>`;
  document.getElementById('saveWeb').addEventListener('click', ()=>{ const v = document.getElementById('teleWebhook').value.trim(); localStorage.setItem(STORAGE_TELEWEB, v); showToast('Saved'); });
  document.getElementById('clearWeb').addEventListener('click', ()=>{ localStorage.removeItem(STORAGE_TELEWEB); document.getElementById('teleWebhook').value=''; showToast('Cleared'); });

  // backup hooks
  document.getElementById('exportBackupBtn').addEventListener('click', exportBackup);
  const inp = document.getElementById('importBackupInput');
  document.getElementById('importBackupBtn').addEventListener('click', ()=>{ if(inp.files.length) importBackupFile(inp.files[0]); else showToast('Choose a file first'); });
}

/* Admin actions */
function canReview(){ const role = (USERS[CURRENT_ID] && USERS[CURRENT_ID].role) || 'user'; return (role==='moderator' || role==='admin' || role==='superadmin'); }
function adminApprove(id){ if(!canReview()) return showToast('No permission'); const subs = loadSubs(); const s = subs.find(x=>x.id===id); if(!s) return; s.status = 'approved'; USERS[s.userId] = USERS[s.userId] || { id:s.userId, role:'user', balance:0, refBalance:0, completedTasks:[], referrals:[], referrer:null, notifications:[] }; const u = USERS[s.userId]; if(!u.completedTasks.includes(s.taskIndex)) u.completedTasks.push(s.taskIndex); const reward = (TASKS[s.taskIndex] && TASKS[s.taskIndex].reward) ? TASKS[s.taskIndex].reward : 0; u.balance = (u.balance||0) + reward; u.notifications = u.notifications||[]; u.notifications.push({ id:'n_'+Date.now(), title:'Approved', message:'Task '+(s.taskIndex+1)+' approved. Reward added.', createdAt:Date.now(), read:false }); saveSubs(subs); saveUsers(); try{ distributeReferralRewards(s.userId, reward); }catch(e){ console.warn('Referral distribution failed', e); } showToast('Approved'); refreshAdminPanels(); }
function adminReject(id){ if(!canReview()) return showToast('No permission'); const subs = loadSubs(); const s = subs.find(x=>x.id===id); if(!s) return; s.status = 'rejected'; USERS[s.userId] = USERS[s.userId] || { id:s.userId, role:'user', balance:0, refBalance:0, completedTasks:[], referrals:[], referrer:null, notifications:[] }; USERS[s.userId].notifications = USERS[s.userId].notifications||[]; USERS[s.userId].notifications.push({ id:'n_'+Date.now(), title:'Rejected', message:'Your submission was rejected.', createdAt:Date.now(), read:false }); saveSubs(subs); saveUsers(); showToast('Rejected'); refreshAdminPanels(); }
function assignSubmissionTo(subId, moderatorId){ const subs = loadSubs(); const s = subs.find(x=>x.id===subId); if(!s) return; s.assignedTo = moderatorId; saveSubs(subs); showToast('Assigned'); if(USERS[moderatorId]){ USERS[moderatorId].notifications = USERS[moderatorId].notifications||[]; USERS[moderatorId].notifications.push({ id:'n_'+Date.now(), title:'Assigned review', message:'You were assigned submission '+subId, createdAt:Date.now(), read:false }); saveUsers(); } }

/* =========================
   REFERRAL / DISTRIBUTE (safe)
   ========================= */
function handleJoinParam(){ try{ const params = new URLSearchParams(location.search); const join = params.get('join'); if(!join) return; if(join === CURRENT_ID) return; if(!USERS[CURRENT_ID]) USERS[CURRENT_ID] = { id:CURRENT_ID, role:'user', balance:0, refBalance:0, completedTasks:[], referrals:[], referrer:null, notifications:[] }; if(!USERS[CURRENT_ID].referrer){ if(!USERS[join]) USERS[join] = { id:join, role:'user', balance:0, refBalance:0, completedTasks:[], referrals:[], referrer:null, notifications:[] }; USERS[CURRENT_ID].referrer = join; USERS[join].referrals = USERS[join].referrals || []; if(!USERS[join].referrals.includes(CURRENT_ID)) USERS[join].referrals.push(CURRENT_ID); saveUsers(); showToast('Joined via referral'); } }catch(e){ console.warn('join param failed', e); } }
function distributeReferralRewards(userId, amount){ try{ const tierPerc = [0.20,0.08,0.02]; let ref = USERS[userId] && USERS[userId].referrer; for(let i=0;i<tierPerc.length && ref;i++){ if(!USERS[ref]) USERS[ref] = { id:ref, role:'user', balance:0, refBalance:0, completedTasks:[], referrals:[], referrer:null, notifications:[] }; const bonus = +(amount * tierPerc[i]).toFixed(2); USERS[ref].refBalance = (USERS[ref].refBalance||0) + bonus; USERS[ref].notifications = USERS[ref].notifications||[]; USERS[ref].notifications.push({ id:'n_'+Date.now()+'_'+i, title:'Referral bonus', message:'You earned $'+bonus+' from referral level '+(i+1), createdAt: Date.now(), read:false }); saveUsers(); ref = USERS[ref].referrer; } }catch(e){ console.warn('distribute error', e); } }

/* =========================
   EXPIRY WORKER
   ========================= */
function expiryCheck(){ const subs = loadSubs(); let changed = false; const now = Date.now(); subs.forEach(s=>{ if(s.status==='pending' && s.createdAt + 5*60*1000 < now){ s.status='expired'; USERS[s.userId] = USERS[s.userId]||{ id:s.userId, role:'user', balance:0, refBalance:0, completedTasks:[], referrals:[], referrer:null, notifications:[] }; USERS[s.userId].notifications = USERS[s.userId].notifications||[]; USERS[s.userId].notifications.push({ id:'n_'+Date.now(), title:'Expired', message:'Submission expired. Please redo.', createdAt:Date.now(), read:false }); changed = true; } }); if(changed){ saveSubs(subs); saveUsers(); refreshAdminPanels(); } }
setInterval(expiryCheck, 30000);

/* =========================
   BACKUP / RESTORE (with preview modal)
   ========================= */
function exportBackup(){
  const allData = {};
  for (let i = 0; i < localStorage.length; i++){
    const key = localStorage.key(i);
    allData[key] = localStorage.getItem(key);
  }
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "HolderW8rBackup_" + Date.now() + ".json";
  a.click(); URL.revokeObjectURL(url);
  showToast("Backup exported!");
}

function importBackupFile(file){
  const reader = new FileReader();
  reader.onload = function (e){
    let data;
    try{ data = JSON.parse(e.target.result); } catch(err){ alert("Invalid file format!"); return; }
    showBackupPreview(data);
  };
  reader.readAsText(file);
}

function showBackupPreview(data){
  // remove existing
  const existing = document.getElementById('backupPreviewModal');
  if(existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'backupPreviewModal';
  modal.innerHTML = `<div class="box"><h3>Backup Preview</h3><pre style="white-space:pre-wrap; font-size:12px; color:var(--muted); max-height:60vh; overflow:auto;">${JSON.stringify(data, null, 2)}</pre>
    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px">
      <button class="btn" id="confirmImport">Import</button>
      <button class="btn" id="cancelImport">Cancel</button>
    </div></div>`;
  document.body.appendChild(modal);
  document.getElementById('cancelImport').addEventListener('click', ()=>modal.remove());
  document.getElementById('confirmImport').addEventListener('click', ()=>{
    for (const key in data) localStorage.setItem(key, data[key]);
    modal.remove();
    showToast('Backup restored ‚Äî reloading');
    setTimeout(()=> location.reload(), 700);
  });
}

/* =========================
   HELPERS & INIT
   ========================= */
function refreshAdminPanels(){ try{ if(document.getElementById('admContent')){ // attempt to re-run the last clicked view by clicking the buttons if present
    // prefer subs
    const subsBtn = document.querySelector('#fullAdminPanel #admSubsBtn');
    if(subsBtn) subsBtn.click();
  }}catch(e){ console.warn(e); } }

function renderTasksForUser(){ document.getElementById('uidTop').textContent = CURRENT_ID; renderWallet(); renderTaskList(); }

function renderSubsAdmin(){ try{ renderAdminSubmissions(true); }catch(e){} }

function init(){
  // join param
  handleJoinParam();

  document.getElementById('navTasks').addEventListener('click', ()=>showUserScreen('tasks'));
  document.getElementById('navWallet').addEventListener('click', ()=>showUserScreen('home'));
  document.getElementById('navReferralBtn').addEventListener('click', ()=>showUserScreen('referral'));
  document.getElementById('navNotifs').addEventListener('click', ()=>showUserScreen('notifs'));
  document.getElementById('backUserFlow').addEventListener('click', ()=>{ showUserScreen('tasks'); });
  document.getElementById('copyRefBtn').addEventListener('click', copyRef);
  document.getElementById('openRefBtn').addEventListener('click', openJoin);
  document.getElementById('adminLoginBtn').addEventListener('click', attemptAdminLogin);
  document.getElementById('openAdminBtn')?.addEventListener('click', ()=>{ openFullAdminPanel(); });
  document.getElementById('logoutAdminBtn')?.addEventListener('click', ()=>{ document.getElementById('adminApp').style.display='none'; document.getElementById('fullAdminPanel').style.display='none'; });

  const fab = document.getElementById('fabAdmin'); if(fab){ fab.addEventListener('click', ()=>{ document.getElementById('adminLogin').style.display='block'; document.getElementById('adminApp').style.display='none'; }); }
  const navAdmin = document.getElementById('navAdminBtn'); if(navAdmin){ navAdmin.addEventListener('click', ()=>{ document.getElementById('adminLogin').style.display='block'; document.getElementById('adminApp').style.display='none'; }); }

  // deposit/withdraw stubs preserved from original
  // initial render
  renderTasksForUser(); renderTaskList(); renderWallet(); renderReferral(); renderNotifications();

  // small animated popup
  setInterval(showTaskPopup, 15000);
}

function attemptAdminLogin(){ const p = (document.getElementById('adminPass')||{}).value.trim(); const ROLE_CODES = { superadmin:'SUPER999', admin:'ADMIN777', moderator:'MOD555' }; let assigned = null; Object.keys(ROLE_CODES).forEach(r=>{ if(p === ROLE_CODES[r]) assigned = r; }); if(!assigned){ showToast('Wrong password'); return; } USERS[CURRENT_ID].role = assigned; saveUsers(); showToast('Logged in as '+assigned); document.getElementById('adminLogin').style.display='none'; document.getElementById('adminApp').style.display='block'; openFullAdminPanel(); }

/* Task popup */
let popupIndex = 0;
function showTaskPopup(){ const p = document.getElementById('taskPopup'); if(!p) return; if(!Array.isArray(TASKS) || TASKS.length===0) return; const t = TASKS[popupIndex % TASKS.length]; p.innerHTML = `<strong>${t.title}</strong><br>$${t.reward} reward<br><div style="margin-top:8px"><button class='btn' style='padding:6px 8px' onclick='openUserTask(${popupIndex % TASKS.length})'>Open Task</button></div>`; p.style.display='block'; p.style.animation = 'popupScale 450ms cubic-bezier(.2,.9,.3,1) both'; setTimeout(()=>{ p.style.display='none'; },10000); popupIndex++; }

init();

</script>

</body>
</html>
